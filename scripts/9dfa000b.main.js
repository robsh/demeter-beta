function getRandomArbitary(a,b){return Math.random()*(b-a)+a}var PARSE_MASTER_KEY="yu7JSONRyPiLdqNnB8CE4FTTRq2cX7XYpqkgXKFG",PARSE_JAVASCRIPT_KEY="teZjsgnov9LixPqIl0IIXU9f3NoYE82wG8Heo8yi",FACEBOOK_APP_ID="186183208245915",FACEBOOK_CHANNGEL_URL="http://localhost:9000";Parse.initialize(PARSE_MASTER_KEY,PARSE_JAVASCRIPT_KEY),function(){if(!document.getElementById("facebook-jssdk")){var a=document.getElementsByTagName("script")[0],b=document.createElement("script");b.id="facebook-jssdk",b.src="//connect.facebook.net/en_US/all.js",a.parentNode.insertBefore(b,a),window.fbAsyncInit=function(){Parse.FacebookUtils.init({appId:FACEBOOK_APP_ID,channelUrl:FACEBOOK_CHANNGEL_URL+"/channel.html",status:!1,cookie:!0,xfbml:!0})}}}(),window.demeter={},demeter.Models={},demeter.Collections={},demeter.Views={},demeter.Routers={},demeter.Vent=_.extend({},Backbone.Events),demeter.Parameters={radius:3,latitude:51.8972,longitude:-8.47},demeter.init=function(){"use strict";new demeter.Views.AppView({el:$(".container"),model:new demeter.Models.AppModel})},$(document).ready(function(){"use strict";demeter.init()}),this.JST=this.JST||{},this.JST["app/scripts/templates/app.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/establishment.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)__p+='<br>\n<a class="nav" href="#search"><i class="fa fa-angle-double-left"></i> Back to search</a>\n\n<div class="col-lg-12">\n<h3>'+(null==(__t=model.name)?"":__t)+"</h3>\n<address>\n	<strong>Address:</strong><br>\n	",_.each(model.vicinity.split(","),function(a){__p+="\n		"+(null==(__t=a)?"":__t)+"<br>\n	"}),__p+='\n	<abbr title="Phone">P:</abbr> '+(null==(__t=model.phone_number)?"":__t)+'\n</address>\n\nReview a meal <a href="#writereview" class="writereview">@'+(null==(__t=model.sname)?"":__t)+"</a>\n<br><br>\n	<strong>Honest reviews for "+(null==(__t=model.name)?"":__t)+':</strong>\n	<hr>\n</div>\n\n\n\n<div class="reviews col-lg-12">\n		<div class="preReviewSearch"><i class="fa fa-spinner fa-spin"></i> Fetching reviews.</div>\n\n		<div class="noReviews hidden">No reviews so far. Be the first <a href="#writereview" class="writereview">@'+(null==(__t=model.sname)?"":__t)+"</a>!</div>\n</div>";return __p},this.JST["app/scripts/templates/establishmentList.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<br>\n<a class="nav" href="#search"><i class="fa fa-angle-double-left"></i> Back to search</a>\n<br>\n<h4>Top restaraunts near you.</h4>\n<br>\n<div class="list"></div>';return __p},this.JST["app/scripts/templates/establishmentListItem.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)__p+='<div class="establishmentListItem">\n\n<strong><a href="#'+(null==(__t=model.sname)?"":__t)+'" >'+(null==(__t=model.name)?"":__t)+"</a></strong>\n<address>\n	",_.each(model.vicinity.split(","),function(a){__p+="\n		"+(null==(__t=a)?"":__t)+"<br>\n	"}),__p+='\n	<abbr title="Phone">P:</abbr> '+(null==(__t=model.phone_number)?"":__t)+"\n</address>\n\n<hr>\n</div>\n";return __p},this.JST["app/scripts/templates/login.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="clearLabel" aria-hidden="true">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n        <h4 class="modal-title">Login</h4>\n      </div>\n      <div class="modal-body">\n        <form role="form">\n          <div class="form-group">\n            <label for="exampleInputEmail1">Email address</label>\n            <input type="email" class="form-control email-input" id="exampleInputEmail1" placeholder="Enter email">\n          </div>\n          <div class="form-group">\n            <label for="exampleInputPassword1">Password</label>\n            <input type="password" class="form-control password-input" id="exampleInputPassword1" placeholder="Password">\n          </div>\n        </form>\n\n        <div class="row">\n        <a class="btn btn-lg btn-primary" href="#facebook-login">\n          <i class="fa fa-facebook-square fa-2x pull-left"></i><span style="vertical-align:sub">Login with Facebook</span>\n        </a>\n        </div>\n\n        <br/>\n        <p>Not signed up? <a class="transfer-modal-login" href="#">Sign up now.</a></p>\n        <p class="flash"></p>\n      </div>\n\n      <div class="modal-footer">\n        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>\n        <button type="button" id="login" class="btn login-submit-button btn-primary">Login</button>\n      </div>\n    </div>\n  </div>\n</div>\n\n';return __p},this.JST["app/scripts/templates/map.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/places.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/review.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)__p+='<div class="areview">\n\n<p class="lead">'+(null==(__t=model.review)?"":__t)+"</p>\n<div>",_.each([0,1,2,3,4],function(a){__p+="\n",__p+=a<=model.rating?'\n	<i class="fa fa-star"></i>\n':'\n<i class="fa fa-star-o"></i>\n',__p+="\n"}),__p+=' <i class="fa fa-eur"></i> '+(null==(__t=model.price)?"":__t)+"\n</div>\n<small>by "+(null==(__t=model.username)?"":__t)+"</small>\n\n<hr>\n\n\n\n</div>";return __p},this.JST["app/scripts/templates/reviewListItem.ejs"]=function(obj){obj||(obj={});{var __t,__p="";_.escape,Array.prototype.join}with(obj)__p+='<div class="areview">\n\n<p class="lead">'+(null==(__t=model.review)?"":__t)+"</p>\n<div>",_.each([0,1,2,3,4],function(a){__p+="\n",__p+=a<=model.rating?'\n	<i class="fa fa-star"></i>\n':'\n<i class="fa fa-star-o"></i>\n',__p+="\n"}),__p+=' <i class="fa fa-eur"></i> '+(null==(__t=model.price)?"":__t)+"\n</div>\n<small>by "+(null==(__t=model.username)?"":__t)+"</small>\n\n<hr>\n\n\n\n</div>";return __p},this.JST["app/scripts/templates/reviewlist.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<br>\n<a class="nav" href="#search"><i class="fa fa-angle-double-left"></i> Back to search</a>\n<br>\n<h4>Hashtags.</h4>\n<br>\n<div class="list">\n	<div class="preReviewSearch"><i class="fa fa-spinner fa-spin"></i> Fetching reviews.</div>\n</div>\n\n';return __p},this.JST["app/scripts/templates/search.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/signup.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<div class="modal fade" id="signupModal" tabindex="-1" role="dialog" aria-labelledby="clearLabel" aria-hidden="true">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n        <h4 class="modal-title">Signup</h4>\n      </div>\n      <div class="modal-body">\n        <form role="form">\n          <div class="form-group">\n            <label for="exampleInputName1">User name</label>\n            <input type="text" class="form-control name-input" id="exampleInputName1" placeholder="Enter name">\n          </div>\n          <div class="form-group">\n            <label for="exampleInputEmail1">Email address</label>\n            <input type="email" class="form-control email-input" id="exampleInputEmail1" placeholder="Enter email">\n          </div>\n          <div class="form-group">\n            <label for="exampleInputPassword1">Password</label>\n            <input type="password" class="form-control password-input" id="exampleInputPassword1" placeholder="Password">\n          </div>\n        </form>\n\n        <div class="row">\n          <a class="btn btn-lg btn-primary" href="#facebook-signup">\n            <i class="fa fa-facebook-square fa-2x pull-left"></i><span style="vertical-align:sub">Signup with Facebook</span>\n          </a>\n        </div>\n\n        <br/>\n        <p>Already signed up? <a class="transfer-modal-signup" href="#">Login here.</a></p>\n        <p class="flash"></p>\n      </div>\n\n      <div class="modal-footer">\n        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>\n        <button type="button" id="signup" class="btn signup-submit-button btn-primary">Signup</button>\n      </div>\n    </div>\n  </div>\n</div>\n\n';return __p},this.JST["app/scripts/templates/user.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<a href="#logout">Logout</a>';return __p},this.JST["app/scripts/templates/writereview.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.AppModel=Backbone.Model.extend({initialize:function(){this.set({user:Parse.User.current()})}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.AppView=Backbone.View.extend({template:JST["app/scripts/templates/app.ejs"],initialize:function(){this.establishments=new demeter.Collections.EstablishmentCollection,this.initializeRouter(),this.initializeBeforeRenderEvents(),this.render(),this.initializeAfterRenderEvents()},initializeBeforeRenderEvents:function(){demeter.Vent.on("establishment_click",function(a){this.establishmentview(a)},this),demeter.Vent.on("establishment_click_sname",function(a){this.establishmentview_by_sname(a)},this),demeter.Vent.on("establishments_list",function(a){this.establishmentsview(a)},this),demeter.Vent.on("hashtag_list",function(a){this.make_reviewList_view(a)},this),demeter.Vent.on("nav",function(a){this.model.get("router").navigate(a,{trigger:!0})},this),demeter.Vent.on("writereview",function(a){this.writereviewview(a)},this),demeter.Vent.on("mapPoint",function(a){this.initializeCollection(a)},this),demeter.Vent.on("establishments_fetch_failed",function(){this.establishmentsFetchFailed()},this)},initializeCollection:function(a){var b=new Parse.Query(demeter.Models.EstablishmentModel);this.establishments.query=b,this.establishments.query.withinKilometers("geo_location",a,3),this.establishments.fetch({success:function(a){a.length<10?demeter.Vent.trigger("establishments_fetch_failed"):demeter.Vent.trigger("establishments_fetch")}})},initializeAfterRenderEvents:function(){var a=this;$(".nav").click(function(b){a.navigate(b)})},render:function(){this.placesView=new demeter.Views.PlacesView({el:$(".places")}),this.userView=new demeter.Views.UserView({el:$(".user"),model:this.model.get("user")}),this.reviewView=new demeter.Views.ReviewView({el:$(".review"),model:new demeter.Models.ReviewModel,establishments:this.establishments}),this.reviewListView=new demeter.Views.ReviewlistView({el:$(".reviewList"),establishments:this.establishments}),this.searchView=new demeter.Views.SearchView({el:$(".search"),model:new demeter.Models.SearchModel,establishments:this.establishments}),this.establishmentView=new demeter.Views.EstablishmentView({el:$(".establishment"),model:new demeter.Models.EstablishmentModel}),this.establishmentListView=new demeter.Views.EstablishmentListView({el:$(".establishmentList")}),this.mapView=new demeter.Views.MapView({el:$(".map"),model:new demeter.Models.MapModel,establishments:this.establishments}),this.currentView=this.searchView},initializeRouter:function(){var a=this,b=Backbone.Router.extend({routes:{logout:"logout"},navigate:function(b){switch(b){case"writereview":a.writereviewview();break;case"search":a.searchview()}},logout:function(){a.logout()},writereview:function(){a.writereview()}});this.model.set({router:new b}),Backbone.history.start()},logout:function(){Parse.User.logOut(),window.location=""},navigate:function(a){_.isUndefined(a)||a.preventDefault();var b=a.target.hash.slice(1);this.model.get("router").navigate(b,{trigger:!0})},writereviewview:function(a){_.isUndefined(a)||this.reviewView.populate(a),$(this.currentView.el).addClass("hidden"),$(this.reviewView.el).removeClass("hidden"),this.currentView=this.reviewView},searchview:function(){demeter.Vent.trigger("reset_markers"),$(this.currentView.el).addClass("hidden"),$(this.searchView.el).removeClass("hidden"),this.currentView=this.searchView},make_reviewList_view:function(a){demeter.Vent.trigger("reset_markers"),$(this.currentView.el).addClass("hidden"),$(this.reviewListView.el).removeClass("hidden"),this.currentView=this.reviewListView,this.reviewListView.setHashtag(a)},establishmentview_by_sname:function(a){var b=this.establishments.filter(function(b){return b.get("sname")===a})[0];this.establishmentview(b)},establishmentview:function(a){$(this.currentView.el).addClass("hidden"),this.establishmentView.setPlace(a),$(this.establishmentView.el).removeClass("hidden"),this.currentView=this.establishmentView},establishmentsview:function(a){$(this.currentView.el).addClass("hidden"),this.establishmentListView.setCollection(a),$(this.establishmentListView.el).removeClass("hidden"),this.currentView=this.establishmentListView},establishmentsFetchFailed:function(){$(this.placesView.el).removeClass("hidden"),this.placesView.performSearch()}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.UserView=Backbone.View.extend({template:JST["app/scripts/templates/user.ejs"],initialize:function(){this.render(),demeter.Vent.on("login",function(){this.render()},this)},render:function(){Parse.User.current()?$(this.el).empty().append(this.template({model:Parse.User})):this.needsLogin()},needsLogin:function(){new demeter.Views.LoginView({el:this.el,model:this.model}),new demeter.Views.SignupView({el:this.el,model:this.model})}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.SignupView=Backbone.View.extend({template:JST["app/scripts/templates/signup.ejs"],events:{"click .signup-button":"signupButtonClick","click .transfer-modal-signup":"transferModal"},initialize:function(){$(this.el).append(this.template()),$(this.el).find(".signup-button").removeClass("hidden"),this.$modal=$(this.el).find("#signupModal"),this.$facebooksignupButton=this.$modal.find("a[href$=#facebook-signup]"),this.$signupSubmitButton=this.$modal.find(".signup-submit-button"),this.$emailInput=this.$modal.find(".email-input"),this.$nameInput=this.$modal.find(".name-input"),this.$passwordInput=this.$modal.find(".password-input"),this.$flash=this.$modal.find(".flash"),this.initializeEvents()},initializeEvents:function(){var a=this;this.$facebooksignupButton.click(function(b){a.facebooksignup(b)}),this.$signupSubmitButton.click(function(b){a.emailsignup(b)}),demeter.Vent.on("signupRequest",function(a){this.setTitle(a),this.signupButtonClick()},this)},signupButtonClick:function(a){_.isUndefined(a)||a.preventDefault(),this.$modal.modal()},killModal:function(){this.$modal.modal("toggle"),$(".modal-backdrop").remove()},transferModal:function(a){a.preventDefault(),this.killModal(),demeter.Vent.trigger("loginRequest","Login")},setTitle:function(a){this.$modal.find(".modal-title").text(a)},emailsignup:function(){var a=this,b=this.$signupSubmitButton.html();this.$signupSubmitButton.html('<i class="fa fa-spin fa-spinner"></i> Signup');var c=this.$emailInput.val(),d=this.$passwordInput.val(),e=this.$nameInput.val(),f=new Parse.User;f.set("username",c),f.set("password",d),f.set("email",c),f.set("name",e),f.signUp(null,{success:function(){a.$signupSubmitButton.html(b),a.signupSuccess()},error:function(c,d){a.$signupSubmitButton.html(b),a.$flash.text(d.message)}})},facebooksignup:function(a){var b=this;a.preventDefault(),this.$facebooksignupButton.find("i").removeClass("fa-facebook-square").addClass("fa-spinner fa-spin"),Parse.FacebookUtils.logIn(null,{success:function(){b.signupSuccess()},error:function(){alert("User cancelled the Facebook signup or did not fully authorize.")}})},signupSuccess:function(){this.killModal(),this.modal=Parse.User.current(),demeter.Vent.trigger("login")}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.LoginView=Backbone.View.extend({template:JST["app/scripts/templates/login.ejs"],events:{"click .login-button":"loginButtonClick","click .transfer-modal-login":"transferModal"},initialize:function(){$(this.el).append(this.template()),$(this.el).find(".login-button").removeClass("hidden"),this.$modal=$(this.el).find("#loginModal"),this.$facebookLoginButton=this.$modal.find("a[href$=#facebook-login]"),this.$loginSubmitButton=this.$modal.find(".login-submit-button"),this.$emailInput=this.$modal.find(".email-input"),this.$passwordInput=this.$modal.find(".password-input"),this.$flash=this.$modal.find(".flash"),this.initializeEvents()},initializeEvents:function(){var a=this;this.$facebookLoginButton.click(function(b){a.facebookLogin(b)}),this.$loginSubmitButton.click(function(b){a.emailLogin(b)}),demeter.Vent.on("loginRequest",function(a){this.setTitle(a),this.loginButtonClick()},this)},loginButtonClick:function(a){_.isUndefined(a)||a.preventDefault(),this.$modal.modal()},killModal:function(){this.$modal.modal("toggle"),$(".modal-backdrop").remove()},transferModal:function(a){a.preventDefault(),this.killModal(),demeter.Vent.trigger("signupRequest","Sign up")},setTitle:function(a){this.$modal.find(".modal-title").text(a)},emailLogin:function(a){a.preventDefault();var b=this,c=this.$loginSubmitButton.html();this.$loginSubmitButton.html('<i class="fa fa-spin fa-spinner"></i> Login');var d=this.$emailInput.val(),e=this.$passwordInput.val();Parse.User.logIn(d,e,{success:function(){b.$loginSubmitButton.html(c),b.loginSuccess()},error:function(a,d){b.$loginSubmitButton.html(c),b.$flash.text(d.message)}})},facebookLogin:function(a){var b=this;a.preventDefault(),this.$facebookLoginButton.find("i").removeClass("fa-facebook-square").addClass("fa-spinner fa-spin"),Parse.FacebookUtils.logIn(null,{success:function(a){a.existed()||b.facebookPopulateDetails(),b.loginSuccess()},error:function(){this.$facebookLoginButton.find("i").addClass("fa-facebook-square").removeClass("fa-spinner fa-spin"),b.loginFailure()}})},loginSuccess:function(){this.killModal(),this.modal=Parse.User.current(),demeter.Vent.trigger("login")},loginFailure:function(){},facebookPopulateDetails:function(){var a=Parse.User.current();FB.api("/"+a.toJSON().authData.facebook.id,function(b){a.set("fid",b.id),a.set("name",b.name),a.set("fusername",b.username),a.set("location",b.location),a.set("link",b.link),a.save()})}})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.UserModel=Parse.User.extend({})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.ReviewView=Backbone.View.extend({template:JST["app/scripts/templates/review.ejs"],initialize:function(a){this.establishments=a.establishments,this.$flash=$(this.el).find(".flash"),this.$submitButton=$(this.el).find(".submit-review"),this.originalHTML=this.$submitButton.html(),this.$ratingVal=$(this.el).find("#ratingval"),this.$priceInput=$(this.el).find(".number-input"),this.$textareaPlaceholder=$("#textareaPlaceholder"),this.resetTextarea(),this.initializeEvents()},initializeEvents:function(){var a=this;demeter.Vent.on("establishments_fetch",function(){a.setupMentions()}),this.$submitButton.click(function(b){a.submitReviewButtonClick(b)})},resetTextarea:function(){this.$textareaPlaceholder.empty(),this.$textareaPlaceholder.append('<textarea class="form-control" rows="6" placeholder="@Luigis was awesome. 5 euro pizza #pizza"></textarea>'),this.$textarea=$(this.el).find("textarea")},submitReviewButtonClick:function(a){a.preventDefault(),Parse.User.current()?this.submitReview():demeter.Vent.trigger("signupRequest","You need to sign up to write a review.")},setupMentions:function(){var a=[];this.resetTextarea(),this.establishments.each(function(b){var c={};c.name=b.get("name"),c.username=b.get("sname"),c.id=b.id,a.push(c)}),this.$textarea.mention({delimiter:"@",users:a})},reviewReset:function(){this.$flash.html("Review submitted! Thank you."),this.$textarea.val(""),this.$priceInput.val("0"),$(".rating-input").find("span").each(function(a,b){$(b).removeClass("fa-star fa-star-o"),a>2?$(b).addClass("fa-star-o"):$(b).addClass("fa-star")}),$("#ratingval").val("2")},reviewTest:function(a){return""===a.get("review")?(this.$flash.html("Please write a review."),!1):_.isUndefined(a.get("mention"))?(this.$flash.html("Please mention one restaurant."),!1):0===a.get("hashtags").length?(this.$flash.html("Please hashtag the food you had."),!1):0===a.get("price")?(this.$flash.html("Please enter a price."),!1):!0},submitReview:function(){var a=this;this.$flash.html("");var b=this.$ratingVal.val(),c=this.$priceInput.val(),d=this.$textarea.val(),e=twttr.txt.extractMentions(d),f=twttr.txt.extractHashtags(d),g=this.establishments.find(function(a){return a.get("sname")===e[0]});console.log(g);var h=new demeter.Models.ReviewModel;h.set("rating",parseInt(b)+1),h.set("price",parseInt(c)),h.set("review",d),h.set("hashtags",f),h.set("uid",Parse.User.current().id),h.set("username",Parse.User.current().get("name")),h.set("mention",e[0]),h.set("eid",g.id);var i=this.reviewTest(h);i&&(this.$submitButton.html('<i class="fa fa-spinner fa-spin"></i> '+this.originalHTML),h.save(null,{success:function(){a.$submitButton.html(a.originalHTML),a.reviewReset()},error:function(b,c){a.$submitButton.html(a.originalHTML),a.$flash.html("Error: "+c.message)}}))},populate:function(a){this.$textarea.focus().val("@"+a.get("sname")+" ")}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.WritereviewView=Backbone.View.extend({template:JST["app/scripts/templates/writereview.ejs"]})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.ReviewModel=Parse.Object.extend({className:"Review"})}(),demeter.Collections=demeter.Collections||{},function(){"use strict";demeter.Collections.ReviewsCollection=Parse.Collection.extend({model:demeter.Models.ReviewsModel})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.EstablishmentModel=Parse.Object.extend({className:"Establishment"})}(),demeter.Collections=demeter.Collections||{},function(){"use strict";demeter.Collections.EstablishmentCollection=Parse.Collection.extend({model:demeter.Models.EstablishmentModel})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.MapView=Backbone.View.extend({template:JST["app/scripts/templates/map.ejs"],initialize:function(a){this.centerPoint=new Parse.GeoPoint({latitude:demeter.Parameters.latitude,longitude:demeter.Parameters.longitude}),demeter.Vent.trigger("mapPoint",this.centerPoint),this.establishments=a.establishments,this.markers=[],this.scaleMap(),this.initializeEvents(),this.initializeMap()},initializeMap:function(){$("#over_map").removeClass("hidden");var a=new google.maps.LatLng(this.centerPoint.latitude,this.centerPoint.longitude);this.map=new google.maps.Map(document.getElementById("map_canvas"),{center:a,zoom:15}),this.map.setCenter(a);var b=document.getElementById("pac-input");this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(b),this.infoWindow=new google.maps.InfoWindow,this.service=new google.maps.places.PlacesService(this.map),demeter.Vent.trigger("serviceInitialized",this.service),this.searchBox=new google.maps.places.SearchBox(b),this.initializeMapEvents()},centerMap:function(){var a=new google.maps.LatLng(this.centerPoint.latitude,this.centerPoint.longitude);this.map.setCenter(a)},initializeEvents:function(){var a=this;$(window).resize(function(){a.scaleMap()}),demeter.Vent.on("establishments_fetch",function(){this.setupMarkers()},this)},initializeMapEvents:function(){var a=this;demeter.Vent.on("mapPoint",function(a){this.centerMap(a)},this),google.maps.event.addListenerOnce(this.map,"idle",function(){a.onIdle()}),google.maps.event.addListener(this.searchBox,"places_changed",function(){a.onLocationChange()}),demeter.Vent.on("makeMarkerGoogPoint",function(a){this.markerFromPoint(a)},this),demeter.Vent.on("reset_markers",function(){this.resetMarkers()},this),demeter.Vent.on("unhighlight_markers",function(a){this.unhighlightMarkers(a)},this),demeter.Vent.on("highlight_marker",function(a){this.highlightMarkerFromModel(a)},this),demeter.Vent.on("fadeOut_markers",function(a){this.fadeOutMarkers(a)},this)},scaleMap:function(){this.mapCanvas=$("#map_canvas"),window.innerWidth<1200?$(this.el).height("70%"):$(this.el).height("100%"),this.mapCanvas.width(this.mapCanvas.parent().width()),this.mapCanvas.height("100%")},setupMarkers:function(){var a=this;this.clearMarkers(),this.establishments.each(function(b){a.addMarker(b)})},clearMarkers:function(){var a=this;_.isUndefined(this.markers)||_.each(this.markers,function(b){a.hideMarker(b)}),this.markers=[]},fadeOutMarkers:function(a){var b=this,c=_.pluck(a.toJSON(),"objectId");_.each(this.markers,function(a){_.contains(c,a.objectId)||b.hideMarker(a)})},resetMarkers:function(){var a=this;_.each(this.markers,function(b){a.showMarker(b),a.resetMarkerColor(b)})},unhighlightMarkers:function(){var a=this;_.each(this.markers,function(b){a.resetMarkerColor(b)})},addMarker:function(a){var b=this,c=a.toJSON(),d=new google.maps.LatLng(c.geo_location.latitude,c.geo_location.longitude),e=new google.maps.Marker({map:this.map,position:d,icon:"https://maps.google.com/mapfiles/marker.png"});e.objectId=a.id,this.markers.push(e),google.maps.event.addListener(e,"click",function(){b.onMarkerClick(e,a)})},markerFromPoint:function(a){new google.maps.Marker({map:this.map,position:a,icon:"https://maps.google.com/mapfiles/marker.png"})},hideMarker:function(a){a.setMap(null)},showMarker:function(a){a.setMap(this.map)},resetMarkerColor:function(a){a.setIcon("https://maps.google.com/mapfiles/marker.png")},highlightMarker:function(a){a.setIcon("https://maps.google.com/mapfiles/marker_yellow.png")},highlightMarkerFromModel:function(a){var b=this;_.each(this.markers,function(c){a.id===c.objectId&&b.highlightMarker(c)})},onIdle:function(){$("#pac-input").removeClass("hidden")},onMarkerClick:function(a,b){this.infoWindow.setContent(b.get("name")),this.infoWindow.open(this.map,a),demeter.Vent.trigger("establishment_click",b)},onLocationChange:function(){for(var a,b=this.searchBox.getPlaces(),c=new google.maps.LatLngBounds,d=0;a=b[d];d++)c.extend(a.geometry.location);this.centerPoint=new Parse.GeoPoint({latitude:c.getCenter().lat(),longitude:c.getCenter().lng()}),demeter.Vent.trigger("mapPoint",this.centerPoint)}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.SearchView=Backbone.View.extend({template:JST["app/scripts/templates/search.ejs"],initialize:function(a){this.$textInput=$(this.el).find("input[type=search]"),this.$numberInput=$(this.el).find("input[type=number]"),this.$form=$(this.el).find("form"),this.$btn=$(this.el).find("button[type=submit]"),this.$flash=$(this.el).find(".flash"),this.establishments=a.establishments,this.initializeEvents()},initializeEvents:function(){var a=this;demeter.Vent.on("mapPoint",function(a){this.centerPoint=a},this),demeter.Vent.on("establishments_fetch",function(){this.setupMentions()},this),this.$form.submit(function(b){a.submitForm(b)})},resetForm:function(a){this.$flash.html(""),_.isUndefined(a)||this.$flash.html(a),this.$textInput.val(""),this.$btn.html("Search")},submitForm:function(a){var b=this;if(_.isUndefined(a)||a.preventDefault(),!_.isUndefined(this.centerPoint)){this.$flash.html(""),this.$btn.html('<i class="fa fa-spinner fa-spin"></i> Search');var c=this.$textInput.val(),d=parseInt(this.$numberInput.val()),e=twttr.txt.extractMentions(c),f=twttr.txt.extractHashtags(c);if(""===c)return this.resetForm("You must enter a search");if(e.length>1)return this.resetForm("Please only mention one restaurant.");var g={radius:demeter.Parameters.radius,centerPoint:this.centerPoint,sname:e[0],hashtags:f,price:d};Parse.Cloud.run("EstablishmentSearch",g,{success:function(a){if(console.log(a),1===a.length)demeter.Vent.trigger("establishment_click",a[0]),b.resetForm();else if(a.length>1){var c=new Parse.Collection(a);demeter.Vent.trigger("establishments_list",c),b.resetForm()}else b.noResults()},error:function(){b.resetForm("An error occured.")}})}},noResults:function(){this.resetForm("No results were found.")},setupMentions:function(){$(this.$textInput).focus();var a=[];this.establishments.each(function(b){var c={};c.name=b.get("name"),c.username=b.get("sname"),c.id=b.id,a.push(c)}),this.$textInput.mention({delimiter:"@",users:a})}})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.SearchModel=Backbone.Model.extend({})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.MapModel=Backbone.Model.extend({})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.EstablishmentView=Backbone.View.extend({template:JST["app/scripts/templates/establishment.ejs"],reviewTemplate:JST["app/scripts/templates/review.ejs"],initialize:function(){},setPlace:function(a){this.preRender(),this.model=a,this.render(),demeter.Vent.trigger("unhighlight_markers",a),demeter.Vent.trigger("highlight_marker",a)},render:function(){return _.isUndefined(this.model.get("name"))?(this.renderError(),void 0):($(this.el).html(this.template({model:this.model.toJSON()})),this.$writereview=$(".writereview"),this.initializeReviews(),this.initializeEvents(),void 0)},preRender:function(){$(this.el).html('<br><br><br><h4><i class="fa fa-spinner fa-spin"></i> Fetching restaraunt.</h4>')},renderError:function(){$(this.el).html('<br><br><br><h4><i class="fa fa-ban"></i> We have no data for this restaraunt.</h4>')},renderReviews:function(a){var b=this;$(this.$reviews).empty();var c=[];_.each(a,function(a){var d=b.reviewTemplate({model:a.toJSON()});c.push(d)}),$(this.$reviews).append(c);var d=/#([a-zA-Z0-9]+)/g,e=/@([a-zA-Z0-9]+)/g;$(this.$reviews.find(".areview")).each(function(){$(this).html(b.linkHashtags($(this).html(),d,"#","hashtag"))}),$(this.$reviews.find(".areview")).each(function(){$(this).html(b.linkHashtags($(this).html(),e,"@","mention"))}),this.initializeReviewEvents()},renderNoReviews:function(){$(this.$reviews).find(".noReviews").removeClass("hidden")},renderReviewsError:function(){},onHashtagClick:function(a){_.isUndefined(a)||a.preventDefault();var b=a.target.hash.slice(1);demeter.Vent.trigger("hashtag_list",b)},onMentionClick:function(a){_.isUndefined(a)||a.preventDefault();var b=a.target.hash.slice(1);demeter.Vent.trigger("establishment_click_sname",b)},linkHashtags:function(a,b,c,d){return a.replace(b,'<a class="'+d+'" href="#$1" ">'+c+"$1</a>")},initializeEvents:function(){var a=this;$(this.el).find(".nav").click(function(a){a.preventDefault();var b=a.target.hash.slice(1);demeter.Vent.trigger("nav",b)}),this.$writereview.click(function(b){a.writereview(b)})},initializeReviewEvents:function(){var a=this;$(this.$reviews).find(".hashtag").click(function(b){a.onHashtagClick(b)}),$(this.$reviews).find(".mention").click(function(b){a.onMentionClick(b)})},initializeReviews:function(){var a=this;this.$preReviewSearch=$(this.el).find(".preReviewSearch"),this.$reviews=$(this.el).find(".reviews");var b=new Parse.Query("Review");b.equalTo("eid",this.model.id),b.find({success:function(b){a.$preReviewSearch.addClass("hidden"),b.length>0?a.renderReviews(b):a.renderNoReviews()},error:function(){a.renderReviewsError()}})},writereview:function(a){_.isUndefined(a)||a.preventDefault(),demeter.Vent.trigger("writereview",this.model)}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.EstablishmentListView=Backbone.View.extend({template:JST["app/scripts/templates/establishmentList.ejs"],itemTemplate:JST["app/scripts/templates/establishmentListItem.ejs"],initialize:function(){this.render()
},render:function(){$(this.el).html(this.template()),this.$listEl=$(this.el).find(".list")},renderList:function(){var a=this;this.$listEl.empty();var b=[];this.collection.each(function(c){var d=a.itemTemplate({model:c.toJSON()});b.push(d)}),this.$listEl.append(b),this.initializeListEvents()},setCollection:function(a){demeter.Vent.trigger("fadeOut_markers",a),this.collection=a,this.renderList()},initializeListEvents:function(){var a=this;this.$listEl.find("a").click(function(b){a.onItemClick(b)})},onItemClick:function(a){_.isUndefined(a)||a.preventDefault();var b=a.target.hash.slice(1),c=this.collection.filter(function(a){return a.get("sname")===b})[0];demeter.Vent.trigger("establishment_click",c)}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.PlacesView=Backbone.View.extend({template:JST["app/scripts/templates/places.ejs"],initialize:function(){this.$number=$(this.el).find("#number"),this.$inner_el=$(this.el).find(".places-inner"),this.$flash=$(this.el).find(".flash"),demeter.Vent.on("mapPoint",function(a){this.centerPoint=a},this),demeter.Vent.on("serviceInitialized",function(a){this.service=a},this),this.j=0},performSearch:function(){var a=this,b=new google.maps.LatLng(this.centerPoint.latitude,this.centerPoint.longitude),c={location:b,radius:1e3*demeter.Parameters.radius,types:["food","restaurant"]};this.service.radarSearch(c,function(b,c){a.placesSearchCallback(b,c)})},placesSearchCallback:function(a,b){b==google.maps.places.PlacesServiceStatus.OK&&this.savePlaces(a)},savePlaces:function(a){var b=this;_.each(a,function(a){var c=new demeter.Models.EstablishmentModel;c.set("gid",a.id),c.set("fresh",!0),c.set("reference",a.reference);var d=new Parse.GeoPoint({latitude:a.geometry.location.lat(),longitude:a.geometry.location.lng()});c.set("geo_location",d),c.save(null,{success:function(a){var c=a.toJSON(),d=new google.maps.LatLng(c.geo_location.latitude,c.geo_location.longitude);b.j=b.j+1,b.$number.html(b.j),demeter.Vent.trigger("makeMarkerGoogPoint",d)},error:function(){}})}),this.$flash.removeClass("hidden"),setTimeout(function(){location.reload()},24e4)}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.ReviewlistView=Backbone.View.extend({template:JST["app/scripts/templates/reviewlist.ejs"],itemTemplate:JST["app/scripts/templates/reviewListItem.ejs"],initialize:function(){},setHashtag:function(a){var b=this,c=new Parse.Query("Review");c.equalTo("hashtags",a),this.collection=c.collection(),this.collection.fetch({success:function(){b.render()},error:function(a){console.log(a)}})},render:function(){$(this.el).empty(),$(this.el).append(this.template()),this.$list=$(this.el).find(".list"),this.renderList(),this.initializeEvents()},renderList:function(){var a=this,b=[];this.collection.each(function(c){var d=a.itemTemplate({model:c.toJSON()});b.push(d)}),this.$list.html(b);var c=/#([a-zA-Z0-9]+)/g,d=/@([a-zA-Z0-9]+)/g;$($(this.el).find(".areview")).each(function(){$(this).html(a.linkHashtags($(this).html(),c,"#","hashtag"))}),$($(this.el).find(".areview")).each(function(){$(this).html(a.linkHashtags($(this).html(),d,"@","mention"))}),this.initializeReviewEvents()},initializeEvents:function(){$(this.el).find(".nav").click(function(a){a.preventDefault();var b=a.target.hash.slice(1);demeter.Vent.trigger("nav",b)})},initializeReviewEvents:function(){var a=this;$(this.el).find(".hashtag").click(function(b){a.onHashtagClick(b)}),$(this.el).find(".mention").click(function(b){a.onMentionClick(b)})},onHashtagClick:function(a){_.isUndefined(a)||a.preventDefault();var b=a.target.hash.slice(1);demeter.Vent.trigger("hashtag_list",b)},onMentionClick:function(a){_.isUndefined(a)||a.preventDefault();var b=a.target.hash.slice(1);demeter.Vent.trigger("establishment_click_sname",b)},linkHashtags:function(a,b,c,d){return a.replace(b,'<a class="'+d+'" href="#$1" ">'+c+"$1</a>")}})}();