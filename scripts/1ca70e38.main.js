var PARSE_MASTER_KEY="yu7JSONRyPiLdqNnB8CE4FTTRq2cX7XYpqkgXKFG",PARSE_JAVASCRIPT_KEY="teZjsgnov9LixPqIl0IIXU9f3NoYE82wG8Heo8yi",FACEBOOK_APP_ID="186183208245915",FACEBOOK_CHANNGEL_URL="http://localhost:9000";Parse.initialize(PARSE_MASTER_KEY,PARSE_JAVASCRIPT_KEY),function(){if(!document.getElementById("facebook-jssdk")){var a=document.getElementsByTagName("script")[0],b=document.createElement("script");b.id="facebook-jssdk",b.src="//connect.facebook.net/en_US/all.js",a.parentNode.insertBefore(b,a),window.fbAsyncInit=function(){Parse.FacebookUtils.init({appId:FACEBOOK_APP_ID,channelUrl:FACEBOOK_CHANNGEL_URL+"/channel.html",status:!1,cookie:!0,xfbml:!0})}}}(),window.demeter={},demeter.Models={},demeter.Collections={},demeter.Views={},demeter.Routers={},demeter.Vent=_.extend({},Backbone.Events),demeter.init=function(){"use strict";new demeter.Views.AppView({el:$(".container"),model:new demeter.Models.AppModel})},$(document).ready(function(){"use strict";demeter.init()}),this.JST=this.JST||{},this.JST["app/scripts/templates/app.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/login.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="clearLabel" aria-hidden="true">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n        <h4 class="modal-title">Login</h4>\n      </div>\n      <div class="modal-body">\n        <form role="form">\n          <div class="form-group">\n            <label for="exampleInputEmail1">Email address</label>\n            <input type="email" class="form-control email-input" id="exampleInputEmail1" placeholder="Enter email">\n          </div>\n          <div class="form-group">\n            <label for="exampleInputPassword1">Password</label>\n            <input type="password" class="form-control password-input" id="exampleInputPassword1" placeholder="Password">\n          </div>\n        </form>\n\n        <div class="row">\n        <a class="btn btn-lg btn-primary" href="#facebook-login">\n          <i class="fa fa-facebook-square fa-2x pull-left"></i><span style="vertical-align:sub">Login with Facebook</span>\n        </a>\n        </div>\n\n        <br/>\n        <p>Not signed up? <a class="transfer-modal-login" href="#">Sign up now.</a></p>\n        <p class="flash"></p>\n      </div>\n\n      <div class="modal-footer">\n        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>\n        <button type="button" id="login" class="btn login-submit-button btn-primary">Login</button>\n      </div>\n    </div>\n  </div>\n</div>\n\n';return __p},this.JST["app/scripts/templates/map.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/review.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/search.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},this.JST["app/scripts/templates/signup.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<div class="modal fade" id="signupModal" tabindex="-1" role="dialog" aria-labelledby="clearLabel" aria-hidden="true">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n        <h4 class="modal-title">Signup</h4>\n      </div>\n      <div class="modal-body">\n        <form role="form">\n          <div class="form-group">\n            <label for="exampleInputName1">User name</label>\n            <input type="text" class="form-control name-input" id="exampleInputName1" placeholder="Enter name">\n          </div>\n          <div class="form-group">\n            <label for="exampleInputEmail1">Email address</label>\n            <input type="email" class="form-control email-input" id="exampleInputEmail1" placeholder="Enter email">\n          </div>\n          <div class="form-group">\n            <label for="exampleInputPassword1">Password</label>\n            <input type="password" class="form-control password-input" id="exampleInputPassword1" placeholder="Password">\n          </div>\n        </form>\n\n        <div class="row">\n          <a class="btn btn-lg btn-primary" href="#facebook-signup">\n            <i class="fa fa-facebook-square fa-2x pull-left"></i><span style="vertical-align:sub">Signup with Facebook</span>\n          </a>\n        </div>\n\n        <br/>\n        <p>Already signed up? <a class="transfer-modal-signup" href="#">Login here.</a></p>\n        <p class="flash"></p>\n      </div>\n\n      <div class="modal-footer">\n        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>\n        <button type="button" id="signup" class="btn signup-submit-button btn-primary">Signup</button>\n      </div>\n    </div>\n  </div>\n</div>\n\n';return __p},this.JST["app/scripts/templates/user.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<a href="#logout">Logout</a>';return __p},this.JST["app/scripts/templates/writereview.ejs"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="<p>Your content here.</p>\n\n";return __p},demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.AppModel=Backbone.Model.extend({initialize:function(){this.set({user:Parse.User.current()})}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.AppView=Backbone.View.extend({template:JST["app/scripts/templates/app.ejs"],initialize:function(){this.render(),this.initializeRouter();var a=this;$(".nav").click(function(b){b.preventDefault();var c=b.target.hash.slice(1);a.model.get("router").navigate(c,{trigger:!0})})},render:function(){this.userView=new demeter.Views.UserView({el:$(".user"),model:this.model.get("user")}),this.reviewView=new demeter.Views.ReviewView({el:$(".review"),model:new demeter.Models.ReviewModel}),this.mapView=new demeter.Views.MapView({el:$(".map"),model:new demeter.Models.MapModel}),this.currentView=this.reviewView,this.writereviewview()},initializeRouter:function(){var a=this,b=Backbone.Router.extend({routes:{logout:"logout"},navigate:function(b){switch(b){case"writereview":a.writereviewview();break;case"search":a.searchview()}},logout:function(){a.logout()},writereview:function(){a.writereview()}});this.model.set({router:new b}),Backbone.history.start()},logout:function(){Parse.User.logOut(),window.location=""},writereviewview:function(){$(this.currentView.el).addClass("hidden"),$(this.reviewView.el).removeClass("hidden"),this.currentView=this.reviewView},searchview:function(){$(this.currentView.el).addClass("hidden"),$(this.searchView.el).removeClass("hidden"),this.currentView=this.searchView}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.UserView=Backbone.View.extend({template:JST["app/scripts/templates/user.ejs"],initialize:function(){this.render(),demeter.Vent.on("login",function(){this.render()},this)},render:function(){Parse.User.current()?$(this.el).empty().append(this.template({model:Parse.User})):this.needsLogin()},needsLogin:function(){new demeter.Views.LoginView({el:this.el,model:this.model}),new demeter.Views.SignupView({el:this.el,model:this.model})}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.SignupView=Backbone.View.extend({template:JST["app/scripts/templates/signup.ejs"],events:{"click .signup-button":"signupButtonClick","click .transfer-modal-signup":"transferModal"},initialize:function(){$(this.el).append(this.template()),$(this.el).find(".signup-button").removeClass("hidden"),this.$modal=$(this.el).find("#signupModal"),this.$facebooksignupButton=this.$modal.find("a[href$=#facebook-signup]"),this.$signupSubmitButton=this.$modal.find(".signup-submit-button"),this.$emailInput=this.$modal.find(".email-input"),this.$nameInput=this.$modal.find(".name-input"),this.$passwordInput=this.$modal.find(".password-input"),this.$flash=this.$modal.find(".flash"),this.initializeEvents()},initializeEvents:function(){var a=this;this.$facebooksignupButton.click(function(b){a.facebooksignup(b)}),this.$signupSubmitButton.click(function(b){a.emailsignup(b)}),demeter.Vent.on("signupRequest",function(a){this.setTitle(a),this.signupButtonClick()},this)},signupButtonClick:function(a){_.isUndefined(a)||a.preventDefault(),this.$modal.modal()},killModal:function(){this.$modal.modal("toggle"),$(".modal-backdrop").remove()},transferModal:function(a){a.preventDefault(),this.killModal(),demeter.Vent.trigger("loginRequest","Login")},setTitle:function(a){this.$modal.find(".modal-title").text(a)},emailsignup:function(){var a=this,b=this.$signupSubmitButton.html();this.$signupSubmitButton.html('<i class="fa fa-spin fa-spinner"></i> Signup');var c=this.$emailInput.val(),d=this.$passwordInput.val(),e=this.$nameInput.val(),f=new Parse.User;f.set("username",c),f.set("password",d),f.set("email",c),f.set("name",e),f.signUp(null,{success:function(){a.$signupSubmitButton.html(b),a.signupSuccess()},error:function(c,d){a.$signupSubmitButton.html(b),a.$flash.text(d.message)}})},facebooksignup:function(a){var b=this;a.preventDefault(),this.$facebooksignupButton.find("i").removeClass("fa-facebook-square").addClass("fa-spinner fa-spin"),Parse.FacebookUtils.logIn(null,{success:function(){b.signupSuccess()},error:function(){alert("User cancelled the Facebook signup or did not fully authorize.")}})},signupSuccess:function(){this.killModal(),this.modal=Parse.User.current(),demeter.Vent.trigger("login")}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.LoginView=Backbone.View.extend({template:JST["app/scripts/templates/login.ejs"],events:{"click .login-button":"loginButtonClick","click .transfer-modal-login":"transferModal"},initialize:function(){$(this.el).append(this.template()),$(this.el).find(".login-button").removeClass("hidden"),this.$modal=$(this.el).find("#loginModal"),this.$facebookLoginButton=this.$modal.find("a[href$=#facebook-login]"),this.$loginSubmitButton=this.$modal.find(".login-submit-button"),this.$emailInput=this.$modal.find(".email-input"),this.$passwordInput=this.$modal.find(".password-input"),this.$flash=this.$modal.find(".flash"),this.initializeEvents()},initializeEvents:function(){var a=this;this.$facebookLoginButton.click(function(b){a.facebookLogin(b)}),this.$loginSubmitButton.click(function(b){a.emailLogin(b)}),demeter.Vent.on("loginRequest",function(a){this.setTitle(a),this.loginButtonClick()},this)},loginButtonClick:function(a){_.isUndefined(a)||a.preventDefault(),this.$modal.modal()},killModal:function(){this.$modal.modal("toggle"),$(".modal-backdrop").remove()},transferModal:function(a){a.preventDefault(),this.killModal(),demeter.Vent.trigger("signupRequest","Sign up")},setTitle:function(a){this.$modal.find(".modal-title").text(a)},emailLogin:function(a){a.preventDefault();var b=this,c=this.$loginSubmitButton.html();this.$loginSubmitButton.html('<i class="fa fa-spin fa-spinner"></i> Login');var d=this.$emailInput.val(),e=this.$passwordInput.val();Parse.User.logIn(d,e,{success:function(){b.$loginSubmitButton.html(c),b.loginSuccess()},error:function(a,d){b.$loginSubmitButton.html(c),b.$flash.text(d.message)}})},facebookLogin:function(a){var b=this;a.preventDefault(),this.$facebookLoginButton.find("i").removeClass("fa-facebook-square").addClass("fa-spinner fa-spin"),Parse.FacebookUtils.logIn(null,{success:function(a){a.existed()||b.facebookPopulateDetails(),b.loginSuccess()},error:function(){this.$facebookLoginButton.find("i").addClass("fa-facebook-square").removeClass("fa-spinner fa-spin"),b.loginFailure()}})},loginSuccess:function(){this.killModal(),this.modal=Parse.User.current(),demeter.Vent.trigger("login")},loginFailure:function(){},facebookPopulateDetails:function(){var a=Parse.User.current();FB.api("/"+a.toJSON().authData.facebook.id,function(b){a.set("fid",b.id),a.set("name",b.name),a.set("fusername",b.username),a.set("location",b.location),a.set("link",b.link),a.save()})}})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.UserModel=Parse.User.extend({})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.ReviewView=Backbone.View.extend({template:JST["app/scripts/templates/review.ejs"],initialize:function(){var a=this;this.$flash=$(this.el).find(".flash"),this.$submitButton=$(this.el).find(".submit-review"),this.originalHTML=this.$submitButton.html(),this.$ratingVal=$(this.el).find("#ratingval"),this.$priceInput=$(this.el).find(".number-input"),this.$textareaPlaceholder=$("#textareaPlaceholder"),this.resetTextarea(),this.establishments=new demeter.Collections.EstablishmentCollection,demeter.Vent.on("mapPoint",function(b){var c=new Parse.Query(demeter.Models.EstablishmentModel);this.establishments.query=c,this.establishments.query.withinKilometers("geo_location",b,3),this.establishments.fetch({success:function(b){a.setupMentions(b)}})},this),this.initializeEvents()},resetTextarea:function(){this.$textareaPlaceholder.empty(),this.$textareaPlaceholder.append('<textarea class="form-control" rows="6" placeholder="@Luigis was awesome. 5 euro pizza #pizza"></textarea>'),this.$textarea=$(this.el).find("textarea")},initializeEvents:function(){var a=this;this.$submitButton.click(function(b){a.submitReviewButtonClick(b)})},submitReviewButtonClick:function(a){a.preventDefault(),Parse.User.current()?this.submitReview():demeter.Vent.trigger("signupRequest","You need to sign up to write a review.")},setupMentions:function(){var a=[];this.resetTextarea(),this.establishments.each(function(b){var c={};c.name=b.get("name"),c.username=b.get("sname"),c.id=b.id,a.push(c)}),this.$textarea.mention({delimiter:"@",users:a})},reviewReset:function(){this.$flash.html("Review submitted! Thank you."),this.$textarea.val(""),$(".rating-input").find("span").each(function(a,b){$(b).removeClass("fa-star fa-star-o"),a>2?$(b).addClass("fa-star-o"):$(b).addClass("fa-star")}),$("#ratingval").val("2")},reviewTest:function(a){return""===a.get("review")?(this.$flash.html("Please write a review."),!1):0===a.get("mentions").length?(this.$flash.html("Please mention at least one restaurant."),!1):0===a.get("hashtags").length?(this.$flash.html("Please hashtag the food you had."),!1):0===a.get("price")?(this.$flash.html("Please enter a price."),!1):!0},submitReview:function(){var a=this,b=this.$ratingVal.val(),c=this.$priceInput.val(),d=this.$textarea.val(),e=twttr.txt.extractMentions(d),f=twttr.txt.extractHashtags(d),g=new demeter.Models.ReviewModel;g.set("rating",b),g.set("price",parseInt(c)),g.set("review",d),g.set("mentions",e),g.set("hashtags",f),g.set("uid",Parse.User.current().id),g.set("username",Parse.User.current().get("name"));var h=this.reviewTest(g);h&&(this.$submitButton.html('<i class="fa fa-spinner fa-spin"></i> '+this.originalHTML),g.save(null,{success:function(){a.$submitButton.html(a.originalHTML),a.reviewReset()},error:function(b,c){a.$submitButton.html(a.originalHTML),a.$flash.html("Error: "+c.message)}}))}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.WritereviewView=Backbone.View.extend({template:JST["app/scripts/templates/writereview.ejs"]})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.ReviewModel=Parse.Object.extend({className:"Review"})}(),demeter.Collections=demeter.Collections||{},function(){"use strict";demeter.Collections.ReviewsCollection=Parse.Collection.extend({model:demeter.Models.ReviewsModel})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.EstablishmentModel=Parse.Object.extend({className:"Establishment"})}(),demeter.Collections=demeter.Collections||{},function(){"use strict";demeter.Collections.EstablishmentCollection=Parse.Collection.extend({model:demeter.Models.EstablishmentModel})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.MapView=Backbone.View.extend({template:JST["app/scripts/templates/map.ejs"],initialize:function(){this.radius=3,this.scaleMap(),this.initializeEvents(),this.initializeMap()},initializeMap:function(){$("#over_map").removeClass("hidden"),this.markers=[],this.map=new google.maps.Map(document.getElementById("map_canvas"),{center:new google.maps.LatLng(51.8972,-8.47),zoom:13});var a=document.getElementById("pac-input");this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(a);var b=new google.maps.LatLngBounds,c=b.getCenter();this.center=new google.maps.LatLng(c.b,c.d),this.infoWindow=new google.maps.InfoWindow,this.service=new google.maps.places.PlacesService(this.map),this.centerPoint=new Parse.GeoPoint({latitude:51.8972,longitude:-8.47}),demeter.Vent.trigger("mapPoint",this.centerPoint),this.initializeMapEvents()},initializeEvents:function(){var a=this;$(window).resize(function(){a.scaleMap()})},initializeMapEvents:function(){var a=this;google.maps.event.addListenerOnce(this.map,"idle",function(){a.performSearch()})},afterLocationChange:function(){for(var a,b=this.searchBox.getPlaces(),c=0;a=this.markers[c];c++)a.setMap(null);for(var d,e=new google.maps.LatLngBounds,c=0;d=b[c];c++){var f={url:d.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)},a=new google.maps.Marker({map:self.map,icon:f,title:d.name,position:d.geometry.location});this.markers.push(a),e.extend(d.geometry.location)}var g=e.getCenter();this.center=new google.maps.LatLng(g.b,g.d),this.map.fitBounds(e)},performSearch:function(){var a=this,b={location:this.map.getBounds().getCenter(),radius:1e3*this.radius,types:["food","restaurant"]};this.service.radarSearch(b,function(b,c){a.placesSearchCallback(b,c)})},placesSearchCallback:function(a,b){if(b==google.maps.places.PlacesServiceStatus.OK){this.savePlacesCondition(a);for(var c,d=0;c=a[d];d++)this.createMarker(c)}},scaleMap:function(){this.mapCanvas=$("#map_canvas"),window.innerWidth<1200?$(this.el).height("70%"):$(this.el).height("100%"),this.mapCanvas.width(this.mapCanvas.parent().width()),this.mapCanvas.height("100%")},createMarker:function(a){var b=this,c=new google.maps.Marker({map:b.map,position:a.geometry.location,icon:"https://maps.google.com/mapfiles/marker.png"});google.maps.event.addListener(c,"click",function(){b.service.getDetails(a,function(a,d){return d!=google.maps.places.PlacesServiceStatus.OK?(alert(d),void 0):(b.infoWindow.setContent(a.name),b.infoWindow.open(b.map,c),void 0)})})},savePlacesCondition:function(a){var b=this,c=new Parse.GeoPoint({latitude:this.map.getBounds().getCenter().lat(),longitude:this.map.getBounds().getCenter().lng()}),d=new Parse.Query(demeter.Models.EstablishmentModel);d.withinKilometers("geo_location",c,this.radius),d.count({success:function(c){10>c&&b.savePlaces(a)}})},savePlaces:function(a){var b=[];_.each(a,function(a){var c=new demeter.Models.EstablishmentModel;c.set("gid",a.id),c.set("fresh",!0),c.set("reference",a.reference);var d=new Parse.GeoPoint({latitude:a.geometry.location.lat(),longitude:a.geometry.location.lng()});c.set("geo_location",d),c.save(null,{success:function(){},error:function(a,b){console.log(b.message)}}),b.push(c)})}})}(),demeter.Views=demeter.Views||{},function(){"use strict";demeter.Views.SearchView=Backbone.View.extend({template:JST["app/scripts/templates/search.ejs"]})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.SearchModel=Backbone.Model.extend({})}(),demeter.Models=demeter.Models||{},function(){"use strict";demeter.Models.MapModel=Backbone.Model.extend({})}();